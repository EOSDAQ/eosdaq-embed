!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t=t||self).eosdaq=i()}(this,function(){"use strict";return class{constructor(t,i){this.container=t,this.config=Object.assign({},{targetUrl:"https://eosdaq.com",tokens:[],initialToken:"",origin:"eosdaq.com",theme:"",locale:""},i),this.childProcess=null,this.iframe=null,this.queue=[],this.isLoaded=!1,this.embedSource=this.buildSrcUrl(),this.renderEosdaq(),this.onMessage=this.onMessage.bind(this),this.validOrigin={},this.transactionCb=null,window.addEventListener("message",this.onMessage)}buildSrcUrl(){const{targetUrl:t,initialToken:i,theme:e,locale:s}=this.config;let n=this.splitTokens(),o="",a="";const r=!n||n.length<1||n.length<2&&!n[0];return i&&r&&(n=[]),e&&(o=`&theme=${e}`),s&&(a=`&locale=${s}`),`${t}/embed/${i||n[0]||""}?tokenList=${n.join("-")}${o}${a}`}splitTokens(){const{tokens:t}=this.config;return t.forEach(t=>{if(t.indexOf("_")<0)throw new Error("invalid token");const i=t.split("_"),e=i[0],s=i[1];if(!e||e.length<1||!s||s.length<1)throw new Error("invalid token")}),t}onMessage(t){if(t.origin!==this.config.targetUrl)return;const{data:i,ports:e}=t;"transaction"===i.action&&this.transaction(i.payload,e),"ready"===i.action&&this.onLoad()}guardConfig(t){if(this[t])return this[t];throw Error(`${t} is not found in config`)}renderEosdaq(){const{container:t,embedSource:i}=this,e=document.getElementById(t),s=e.getElementsByTagName("iframe");if(s&&s.length>0)for(const t of s)e.removeChild(t);this.iframe=document.createElement("iframe"),this.iframe.src=i,this.iframe.frameBorder=0,e.appendChild(this.iframe),this.childProcess=this.iframe.contentWindow}sendMessage(t,i,e){const s={action:t,payload:i};e&&e[0]?e[0].postMessage(s):this.childProcess.postMessage(s,this.config.targetUrl)}onLoad(){this.isLoaded=!0,this.queue.length>0&&this.queue.pop()()}async login({identity:t,eos:i,origin:e,transactionCb:s}){t&&(this.identity=t,i&&(this.eos=i),s&&(this.transactionCb=s),this.isLoaded?this.sendMessage("getIdentity",t):this.queue.push(this.sendMessage.bind(this,"getIdentity",t))),e&&(this.config.origin=e),await this.buildValidOrigin(),this.validateOrigin(this.config.tokens)}logout(){this.identity=null,this.eos=null,this.transactionCb=null,this.sendMessage("forgetIdentity")}async buildValidOrigin(){if(Object.keys(this.validOrigin).length>0)return;const{eos:t}=this;if(!t)return void console.log("eos is not injected");const{rows:i}=await t.getTableRows({code:"eosdaqmarket",scope:"eosdaqmarket",table:"stfee",json:!0,limit:-1});i.forEach(t=>{const{basefee:i,quotefee:e,origin:s}=t,n=e.replace(/[0-9. ]/g,""),o=i.replace(/[0-9. ]/g,"");if(!n)return;const a=`${n}_${o}`;this.validOrigin[a]||(this.validOrigin[a]={}),this.validOrigin[a][s]=!0})}validateOrigin(t){const{origin:i}=this.config;i&&t&&(t=t.length?t:[t]).forEach(t=>{this.validOrigin&&this.validOrigin[t]&&this.validOrigin[t][i]||console.error(`Your origin(${i}) is not registered. Use a right origin or send email to contact@eosdaq.com to regist`)})}setOriginOnMemo(t){if(this.config.origin)try{const i=JSON.parse(t.data.memo);i.origin=this.config.origin;const e=Object.keys(i),{length:s}=e;t.data.memo=`{ ${e.map((t,e)=>`"${t}": "${i[t]}"${e!==s-1?", ":""}`).join("")} }`}catch(i){return t}}async transaction(t,i){let e;try{for(const i of t.actions)this.setOriginOnMemo(i);let i;e={success:!0,data:i="function"==typeof this.transactionCb?await this.transactionCb(t):await this.eos.transaction(t),error:null}}catch(t){e={success:!1,data:null,error:t.toString()}}this.sendMessage("transactionResult",e,i)}changeLanguage(t){this.sendMessage("changeLanguage",t)}destroy(){window.removeEventListener("message",this.onMessage),this.isLoaded=!1}}});
//# sourceMappingURL=bundle.eosdaq.js.map
