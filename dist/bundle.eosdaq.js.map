{"version":3,"file":"bundle.eosdaq.js","sources":["../eosdaq.js"],"sourcesContent":["/**\n * config {\n *  container: 'eosdaq' (Id of div)\n *  src: 'https://eosdaq.com/embed/\n * }\n */\n\nclass Eosdaq {\n  constructor(container, config) {\n    const defaultConfig = {\n      targetUrl: 'https://eosdaq.com',\n      tokens: [],\n      initialToken: '',\n      origin: 'eosdaq.com',\n      theme: '',\n      locale: '',\n    };\n\n    this.container = container;\n    this.config = Object.assign({}, defaultConfig, config);\n    this.childProcess = null;\n    this.iframe = null;\n    this.queue = [];\n    this.isLoaded = false;\n    this.embedSource = this.buildSrcUrl();\n\n    this.renderEosdaq();\n    this.onMessage = this.onMessage.bind(this);\n    this.validOrigin = {};\n    this.transactionCb = null;\n    window.addEventListener('message', this.onMessage);\n  }\n\n  buildSrcUrl() {\n    const {\n      targetUrl, initialToken, theme, locale,\n    } = this.config;\n    let tokens = this.splitTokens();\n    let themeQuery = '';\n    let localeQuery = '';\n\n    const isEmptyTokens = (\n      !tokens\n      || tokens.length < 1\n      || (tokens.length < 2 && !tokens[0])\n    );\n\n    if (initialToken) {\n      if (isEmptyTokens) {\n        tokens = [];\n      }\n    }\n\n    if (theme) {\n      themeQuery = `&theme=${theme}`;\n    }\n\n    if (locale) {\n      localeQuery = `&locale=${locale}`;\n    }\n\n    const firstToken = initialToken || tokens[0] || '';\n    return `${targetUrl}/embed/${firstToken}?tokenList=${tokens.join('-')}${themeQuery}${localeQuery}`;\n  }\n\n  splitTokens() {\n    const { tokens } = this.config;\n    tokens.forEach((t) => {\n      const divider = '_';\n      if (t.indexOf(divider) < 0) {\n        throw new Error('invalid token');\n      }\n      const bunch = t.split(divider);\n      const symbol = bunch[0];\n      const baseSymbol = bunch[1];\n      if (!symbol || symbol.length < 1\n        || !baseSymbol || baseSymbol.length < 1) {\n        throw new Error('invalid token');\n      }\n    });\n    return tokens;\n  }\n\n  onMessage(e) {\n    if (e.origin !== this.config.targetUrl) {\n      return;\n    }\n    const { data, ports } = e;\n    if (data.action === 'transaction') {\n      this.transaction(data.payload, ports);\n    }\n    if (data.action === 'ready') {\n      this.onLoad();\n    }\n  }\n\n  guardConfig(configKey) {\n    if (this[configKey]) {\n      return this[configKey];\n    }\n\n    throw Error(`${configKey} is not found in config`);\n  }\n\n  renderEosdaq() {\n    const { container, embedSource } = this;\n\n    const div = document.getElementById(container);\n    const oldies = div.getElementsByTagName('iframe');\n    if (oldies && oldies.length > 0) {\n      for (const oldFrame of oldies) {\n        div.removeChild(oldFrame);\n      }\n    }\n\n    this.iframe = document.createElement('iframe');\n    this.iframe.src = embedSource;\n    this.iframe.frameBorder = 0;\n\n    div.appendChild(this.iframe);\n    this.childProcess = this.iframe.contentWindow;\n  }\n\n  sendMessage(action, payload, ports) {\n    const message = {\n      action,\n      payload,\n    };\n\n    if (ports && ports[0]) {\n      ports[0].postMessage(message);\n      return;\n    }\n\n    this.childProcess.postMessage(message, this.config.targetUrl);\n  }\n\n  onLoad() {\n    this.isLoaded = true;\n    if (this.queue.length > 0) {\n      const work = this.queue.pop();\n      work();\n    }\n  }\n\n  async login({ identity, eos, origin, transactionCb }) {\n    if (identity) {\n      this.identity = identity;\n      if (eos) {\n        this.eos = eos;\n      }\n      if (transactionCb) {\n        this.transactionCb = transactionCb;\n      }\n      if (this.isLoaded) {\n        this.sendMessage('getIdentity', identity);\n      } else {\n        this.queue.push(this.sendMessage.bind(this, 'getIdentity', identity));\n      }\n    }\n    if (origin) {\n      this.config.origin = origin;\n    }\n    await this.buildValidOrigin();\n    this.validateOrigin(this.config.tokens);\n  }\n\n  logout() {\n    this.identity = null;\n    this.eos = null;\n    this.transactionCb = null;\n    this.sendMessage('forgetIdentity');\n  }\n\n  async buildValidOrigin() {\n    const keys = Object.keys(this.validOrigin);\n    if (keys.length > 0) {\n      return;\n    }\n\n    const { eos } = this;\n    if (!eos) {\n      console.log('eos is not injected');\n      return;\n    }\n\n    const { rows } = await eos.getTableRows({\n      code: 'eosdaqmarket',\n      scope: 'eosdaqmarket',\n      table: 'stfee',\n      json: true,\n      limit: -1,\n    });\n\n    rows.forEach((row) => {\n      const { basefee, quotefee, origin } = row;\n      const symbol = quotefee.replace(/[0-9. ]/g, '');\n      const base = basefee.replace(/[0-9. ]/g, '');\n      if (!symbol) {\n        return;\n      }\n      const pair = `${symbol}_${base}`;\n      if (!this.validOrigin[pair]) {\n        this.validOrigin[pair] = {};\n      }\n      this.validOrigin[pair][origin] = true;\n    });\n  }\n\n  validateOrigin(tokens) {\n    const { origin } = this.config;\n    if (!origin || !tokens) {\n      return;\n    }\n    tokens = !tokens.length ? [tokens] : tokens;\n    tokens.forEach((token) => {\n      if (!this.validOrigin || !this.validOrigin[token] || !this.validOrigin[token][origin]) {\n        console.error(`Your origin(${origin}) is not registered. Use a right origin or send email to contact@eosdaq.com to regist`);\n      }\n    });\n  }\n\n  setOriginOnMemo(action) {\n    if (!this.config.origin) {\n      return;\n    }\n    try {\n      const memo = JSON.parse(action.data.memo);\n      memo.origin = this.config.origin;\n      const memoKeys = Object.keys(memo);\n      const { length } = memoKeys;\n      action.data.memo = `{ ${memoKeys.map((key, index) => `\"${key}\": \"${memo[key]}\"${index !== length - 1 ? ', ' : ''}`).join('')} }`;\n    } catch (e) {\n      return action;\n    }\n  }\n\n  async transaction(tx, ports) {\n    let payload;\n\n    try {\n      for (const action of tx.actions) {\n        this.setOriginOnMemo(action);\n      }\n      let result;\n      if (typeof this.transactionCb === 'function') {\n        result = await this.transactionCb(tx);\n\n      } else {\n        result = await this.eos.transaction(tx);\n      }\n\n      payload = {\n        success: true,\n        data: result,\n        error: null,\n      };\n    } catch (error) {\n      payload = {\n        success: false,\n        data: null,\n        error: error.toString(),\n      }\n    }\n    const action = 'transactionResult';\n    this.sendMessage(action, payload, ports);\n  }\n\n  changeLanguage(lang) {\n    this.sendMessage('changeLanguage', lang);\n  }\n\n  destroy() {\n    window.removeEventListener('message', this.onMessage);\n    this.isLoaded = false;\n  }\n}\n\nexport default Eosdaq;\n"],"names":["[object Object]","container","config","this","Object","assign","targetUrl","tokens","initialToken","origin","theme","locale","childProcess","iframe","queue","isLoaded","embedSource","buildSrcUrl","renderEosdaq","onMessage","bind","validOrigin","transactionCb","window","addEventListener","splitTokens","themeQuery","localeQuery","isEmptyTokens","length","join","forEach","t","indexOf","Error","bunch","split","symbol","baseSymbol","e","data","ports","action","transaction","payload","onLoad","configKey","div","document","getElementById","oldies","getElementsByTagName","oldFrame","removeChild","createElement","src","frameBorder","appendChild","contentWindow","message","postMessage","pop","work","identity","eos","sendMessage","push","buildValidOrigin","validateOrigin","keys","console","log","rows","getTableRows","code","scope","table","json","limit","row","basefee","quotefee","replace","base","pair","token","error","memo","JSON","parse","memoKeys","map","key","index","tx","actions","setOriginOnMemo","result","success","toString","lang","removeEventListener"],"mappings":"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"}